# Firebase認証実装仕様書

**作成日**: 2026年1月23日  
**対象システム**: TMG Portal  
**目的**: Firebase認証の実装仕様を他のサイトにも同様に実装するための詳細ドキュメント  
**バージョン**: 1.0

---

## 目次

1. [概要](#1-概要)
2. [アーキテクチャ](#2-アーキテクチャ)
3. [環境変数設定](#3-環境変数設定)
4. [Firebase設定](#4-firebase設定)
5. [認証フロー](#5-認証フロー)
6. [実装ファイル構成](#6-実装ファイル構成)
7. [API仕様](#7-api仕様)
8. [セッション管理](#8-セッション管理)
9. [エラーハンドリング](#9-エラーハンドリング)
10. [開発環境での動作](#10-開発環境での動作)
11. [デプロイ時の注意点](#11-デプロイ時の注意点)
12. [実装手順](#12-実装手順)

---

## 1. 概要

### 1.1 認証方式

- **認証プロバイダー**: Firebase Authentication
- **ログイン方法**: Googleログイン（OAuth 2.0）
- **セッション管理**: Firebase Authのセッション管理機能を使用
- **セッションタイムアウト**: 24時間
- **社員マスタ連携**: BigQueryの`employees`テーブルでメールアドレスを検証

### 1.2 技術スタック

- **フロントエンド**: Next.js 15 (App Router)
- **認証**: Firebase Authentication (v12.6.0)
- **データベース**: BigQuery (employeesテーブル)
- **言語**: TypeScript
- **状態管理**: React Context API

### 1.3 主要機能

1. Googleアカウントでのログイン
2. 社員マスタとの連携によるアクセス制御
3. セッションタイムアウト管理（24時間）
4. 認証状態のリアルタイム監視
5. 開発環境での認証スキップ機能

---

## 2. アーキテクチャ

### 2.1 システム構成図

```
┌─────────────────┐
│   ユーザー      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ログインページ  │
│  /app/login     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│ Firebase Auth   │◄────►│  Google OAuth    │
│ (Google Login)  │      │                  │
└────────┬────────┘      └──────────────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│  AuthContext    │◄────►│  /api/employees  │
│  (状態管理)     │      │  /check-email    │
└────────┬────────┘      └────────┬─────────┘
         │                         │
         │                         ▼
         │                ┌──────────────────┐
         │                │   BigQuery       │
         │                │   employees      │
         │                └──────────────────┘
         │
         ▼
┌─────────────────┐
│  ダッシュボード  │
│  /dashboard     │
└─────────────────┘
```

### 2.2 データフロー

1. **ログイン時**:
   - ユーザーがGoogleでログイン
   - Firebase Authenticationで認証
   - Googleメールアドレスを取得
   - `/api/employees/check-email`で社員マスタを検索
   - 存在する場合のみログイン成功

2. **認証状態監視**:
   - `onAuthStateChanged`でFirebase認証状態を監視
   - 認証状態が変更されたら`AuthContext`を更新
   - 社員情報を取得して`AuthContext`に保存

3. **セッション管理**:
   - ログイン成功時に`localStorage`に`lastSignInTime`を保存
   - ページ遷移時に24時間経過をチェック
   - タイムアウト時は自動ログアウト

---

## 3. 環境変数設定

### 3.1 必須環境変数

以下の環境変数を`.env.local`ファイルに設定する必要があります：

```bash
# Firebase設定
NEXT_PUBLIC_FIREBASE_API_KEY=your-firebase-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-firebase-auth-domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-firebase-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-firebase-storage-bucket
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your-firebase-messaging-sender-id
NEXT_PUBLIC_FIREBASE_APP_ID=your-firebase-app-id
```

### 3.2 環境変数の取得方法

1. Firebase Console (https://console.firebase.google.com/) にアクセス
2. プロジェクトを選択
3. プロジェクト設定（⚙️）→ 全般タブ
4. 「マイアプリ」セクションでWebアプリを選択（または新規追加）
5. 設定オブジェクトから各値を取得

### 3.3 環境変数の説明

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `NEXT_PUBLIC_FIREBASE_API_KEY` | Firebase APIキー | `AIzaSy...` |
| `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | 認証ドメイン | `your-project.firebaseapp.com` |
| `NEXT_PUBLIC_FIREBASE_PROJECT_ID` | プロジェクトID | `your-project-id` |
| `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` | ストレージバケット | `your-project.appspot.com` |
| `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` | メッセージング送信者ID | `123456789012` |
| `NEXT_PUBLIC_FIREBASE_APP_ID` | アプリID | `1:123456789012:web:abc123` |

**重要**: `NEXT_PUBLIC_`プレフィックスが必要です。これによりクライアントサイドで環境変数にアクセスできます。

---

## 4. Firebase設定

### 4.1 Firebase初期化 (`lib/firebase.ts`)

```typescript
import { initializeApp, getApps, FirebaseApp } from 'firebase/app';
import { getAuth, Auth } from 'firebase/auth';

// 環境変数の取得（ビルド時エラーを防ぐため、安全に取得）
const getFirebaseConfig = () => {
  const apiKey = process.env.NEXT_PUBLIC_FIREBASE_API_KEY;
  const authDomain = process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN;
  const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;
  const storageBucket = process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET;
  const messagingSenderId = process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID;
  const appId = process.env.NEXT_PUBLIC_FIREBASE_APP_ID;

  // 必須環境変数がすべて設定されている場合のみ設定オブジェクトを返す
  if (apiKey && authDomain && projectId && storageBucket && messagingSenderId && appId) {
    return {
      apiKey,
      authDomain,
      projectId,
      storageBucket,
      messagingSenderId,
      appId,
    };
  }
  return null;
};

// クライアントサイドでのみ初期化（ビルド時エラーを防ぐ）
let app: FirebaseApp | undefined;
let auth: Auth | undefined;

// クライアントサイドでのみ実行
if (typeof window !== 'undefined') {
  const firebaseConfig = getFirebaseConfig();
  
  if (firebaseConfig) {
    try {
      const existingApps = getApps();
      if (existingApps.length === 0) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
      } else {
        app = existingApps[0];
        auth = getAuth(app);
      }
    } catch (error: any) {
      // ビルド時や環境変数未設定時のエラーを無視
      if (error?.code !== 'auth/invalid-api-key' && !error?.message?.includes('invalid-api-key')) {
        if (process.env.NODE_ENV === 'development') {
          console.warn('Firebase初期化エラー（無視されます）:', error.message);
        }
      }
      auth = undefined;
    }
  }
}

export { auth };
```

### 4.2 重要なポイント

1. **クライアントサイドのみ初期化**: `typeof window !== 'undefined'`でチェック
2. **環境変数の検証**: すべての必須環境変数が設定されている場合のみ初期化
3. **エラーハンドリング**: ビルド時エラーを防ぐため、エラーを適切に処理
4. **シングルトンパターン**: `getApps()`で既存のアプリインスタンスを確認

### 4.3 Firebase Consoleでの設定

1. **認証方法の有効化**:
   - Firebase Console → 認証 → サインイン方法
   - 「Google」を有効化
   - プロジェクトのサポートメールを設定

2. **承認済みドメイン**:
   - Firebase Console → 認証 → 設定 → 承認済みドメイン
   - 本番ドメインを追加（例: `your-domain.com`）

---

## 5. 認証フロー

### 5.1 ログインフロー

```
1. ユーザーが「Googleでログイン」ボタンをクリック
   ↓
2. signInWithGoogle() が呼ばれる
   ↓
3. Firebase AuthenticationでGoogleログイン
   - signInWithPopup(auth, GoogleAuthProvider)
   ↓
4. ログイン成功後、Googleメールアドレスを取得
   - user.email
   ↓
5. 社員マスタでメールアドレスをチェック
   - POST /api/employees/check-email
   - リクエスト: { email: "user@gmail.com" }
   ↓
6. 社員マスタに存在する場合:
   - ログイン成功
   - AuthContextにユーザー情報を保存
   - ダッシュボードにリダイレクト
   ↓
7. 社員マスタに存在しない場合:
   - ログイン失敗
   - エラーメッセージを表示
   - Firebaseからログアウト
```

### 5.2 認証状態監視フロー

```
1. アプリ起動時
   ↓
2. AuthProviderがマウントされる
   ↓
3. onAuthStateChange()でFirebase認証状態を監視開始
   ↓
4. 認証状態が変更されたら:
   - ログイン時: userが設定される
   - ログアウト時: userがnullになる
   ↓
5. userが設定された場合:
   - localStorageにlastSignInTimeを保存
   - 社員情報を取得（/api/employees/check-email）
   - AuthContextにuserとemployeeを保存
   ↓
6. userがnullの場合:
   - AuthContextからuserとemployeeをクリア
   - ログインページにリダイレクト（ログインページ以外の場合）
```

### 5.3 セッションタイムアウトフロー

```
1. ページ遷移時（useEffectでpathnameを監視）
   ↓
2. checkSessionTimeout()が呼ばれる
   ↓
3. localStorageからlastSignInTimeを取得
   ↓
4. 現在時刻 - lastSignInTime > 24時間 の場合:
   - logOut()を実行
   - Firebaseからログアウト
   - localStorageからlastSignInTimeを削除
   - ログインページにリダイレクト
```

---

## 6. 実装ファイル構成

### 6.1 ファイル構成

```
timingood-portal/
├── lib/
│   ├── firebase.ts          # Firebase初期化
│   ├── auth.ts              # 認証ユーティリティ関数
│   └── sso.ts               # SSO関連（他サイト連携用）
├── contexts/
│   └── AuthContext.tsx      # 認証状態管理コンテキスト
├── components/
│   └── ClientAuthProvider.tsx # クライアントサイド認証プロバイダー
├── app/
│   ├── layout.tsx           # ルートレイアウト（AuthProviderを配置）
│   ├── login/
│   │   └── page.tsx        # ログインページ
│   └── api/
│       └── employees/
│           ├── check-email/
│           │   └── route.ts # メールアドレスチェックAPI
│           └── by-google-email/
│               └── route.ts # Googleメールで社員情報取得API
└── lib/services/
    └── bigquery-service.ts  # BigQueryサービス（社員マスタ検索）
```

### 6.2 各ファイルの役割

| ファイル | 役割 | 説明 |
|---------|------|------|
| `lib/firebase.ts` | Firebase初期化 | FirebaseアプリとAuthの初期化 |
| `lib/auth.ts` | 認証関数 | ログイン、ログアウト、認証状態監視 |
| `contexts/AuthContext.tsx` | 認証状態管理 | ユーザー情報と社員情報の状態管理 |
| `components/ClientAuthProvider.tsx` | クライアントプロバイダー | クライアントサイドでのみAuthProviderをレンダリング |
| `app/login/page.tsx` | ログインページ | Googleログインボタンとエラー表示 |
| `app/api/employees/check-email/route.ts` | メールチェックAPI | 社員マスタでメールアドレスを検証 |
| `app/api/employees/by-google-email/route.ts` | 社員情報取得API | Googleメールで社員情報を取得 |

---

## 7. API仕様

### 7.1 メールアドレスチェックAPI

**エンドポイント**: `POST /api/employees/check-email`

**リクエスト**:
```json
{
  "email": "user@gmail.com"
}
```

**レスポンス（成功）**:
```json
{
  "exists": true,
  "employee": {
    "employeeNumber": "TGS0055",
    "name": "仙波 未来",
    "location": "天神",
    "department": "トレーディング課",
    "role": "PM",
    "tmgEmail": "senba@timingood.co.jp",
    "googleEmail": "miku.semba28@gmail.com",
    "chatworkId": "12345678",
    "peakBoardLoginMaill": "senba@timingood.co.jp",
    "peakBoardLoginPass": "encrypted_password"
  }
}
```

**レスポンス（存在しない）**:
```json
{
  "exists": false,
  "message": "このGoogleメールアドレスは社員マスタに登録されていません。Googleメールアドレスが登録されていない可能性があります。"
}
```

**エラーレスポンス**:
```json
{
  "exists": false,
  "error": "エラーメッセージ"
}
```

**ステータスコード**:
- `200`: 成功
- `400`: リクエストエラー（メールアドレスが指定されていない）
- `500`: サーバーエラー

### 7.2 社員情報取得API

**エンドポイント**: `GET /api/employees/by-google-email?google_email={email}`

**クエリパラメータ**:
- `google_email` (必須): Googleメールアドレス

**レスポンス（成功）**:
```json
{
  "employee_number": "TGS0055",
  "name": "仙波 未来",
  "tmg_email": "senba@timingood.co.jp",
  "google_email": "miku.semba28@gmail.com"
}
```

**エラーレスポンス**:
```json
{
  "error": "エラーメッセージ"
}
```

**ステータスコード**:
- `200`: 成功
- `400`: リクエストエラー（google_emailパラメータがない）
- `404`: 社員が見つからない
- `500`: サーバーエラー

### 7.3 BigQueryクエリ

社員マスタ検索は以下のクエリで実行されます：

```sql
SELECT 
  employee_number,
  name,
  location,
  department,
  role,
  tmg_email,
  google_email,
  chatwork_id,
  PeakBoard_loginMaill,
  PeakBoard_loginPass
FROM `{projectId}.{datasetId}.employees`
WHERE google_email = @email
  AND google_email IS NOT NULL
LIMIT 1
```

---

## 8. セッション管理

### 8.1 セッションタイムアウト

- **タイムアウト時間**: 24時間（`SESSION_TIMEOUT_MS = 24 * 60 * 60 * 1000`）
- **保存場所**: `localStorage`の`lastSignInTime`キー
- **チェックタイミング**: ページ遷移時（`useEffect`で`pathname`を監視）

### 8.2 実装詳細

```typescript
// セッションタイムアウトチェック
const checkSessionTimeout = () => {
  const lastSignInTime = localStorage.getItem("lastSignInTime");
  if (!lastSignInTime) return;

  const now = new Date().getTime();
  const lastSignIn = parseInt(lastSignInTime, 10);

  if (now - lastSignIn > SESSION_TIMEOUT_MS) {
    console.log("Session timed out. Logging out...");
    logOut();
  }
};

// ページ遷移時にタイムアウトチェック
useEffect(() => {
  if (user) {
    checkSessionTimeout();
  }
}, [pathname, user]);
```

### 8.3 ログイン時の処理

```typescript
// ログイン成功時
if (firebaseUser) {
  if (!localStorage.getItem("lastSignInTime")) {
    localStorage.setItem("lastSignInTime", new Date().getTime().toString());
  }
  setUser(firebaseUser);
}
```

### 8.4 ログアウト時の処理

```typescript
// ログアウト時
await signOut(auth);
localStorage.removeItem("lastSignInTime");
```

---

## 9. エラーハンドリング

### 9.1 認証エラー

Firebase認証エラーは日本語化されています：

| エラーコード | 日本語メッセージ |
|------------|----------------|
| `auth/popup-closed-by-user` | ログインウィンドウが閉じられました |
| `auth/popup-blocked` | ポップアップがブロックされました。ブラウザの設定でポップアップを許可してください |
| `auth/cancelled-popup-request` | ログインがキャンセルされました |
| `auth/account-exists-with-different-credential` | このメールアドレスは既に別の認証方法で登録されています |
| `auth/operation-not-allowed` | この認証方法は許可されていません |
| `auth/unauthorized-domain` | このドメインは許可されていません |
| その他 | Googleログインに失敗しました。もう一度お試しください |

### 9.2 社員マスタエラー

| エラー | メッセージ | 処理 |
|--------|----------|------|
| メールアドレスが取得できない | メールアドレスが取得できませんでした | Firebaseからログアウト |
| 社員マスタに存在しない | このGoogleメールアドレスは社員マスタに登録されていません。ログインアカウントが間違ってなければシステム課にお問い合わせください。 | Firebaseからログアウト |
| APIタイムアウト | 社員マスタAPIへの接続がタイムアウトしました。 | エラー表示 |
| ネットワークエラー | 社員マスタAPIサーバーに接続できません。 | エラー表示 |
| サーバーエラー | 社員マスタAPIサーバーでエラーが発生しました。しばらく待ってから再度お試しください。 | エラー表示 |

### 9.3 エラーハンドリングの実装

```typescript
try {
  await signInWithGoogle();
  router.push("/dashboard");
} catch (err: any) {
  console.error(err);
  const errorMessage = err?.message || err?.toString() || "ログインに失敗しました。";
  setError(errorMessage);

  // エラー時はログアウト
  try {
    await logOut();
  } catch {
    // 無視
  }
}
```

---

## 10. 開発環境での動作

### 10.1 localhostでの認証スキップ

開発環境（localhost）では、Firebase認証をスキップしてダミーユーザーを使用します。

**判定方法**:
```typescript
const isLocalhost = (): boolean => {
  if (typeof window === "undefined") return false;
  const hostname = window.location.hostname;
  return hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1";
};
```

**ダミーユーザー**:
```typescript
const createMockUser = (): FirebaseUser => {
  return {
    uid: "test-user-tgs0055",
    email: "miku.semba28@gmail.com",
    displayName: "仙波 未来",
    // ... その他のプロパティ
  } as FirebaseUser;
};

const createMockEmployee = (): Employee => {
  return {
    employeeNumber: "TGS0055",
    name: "仙波 未来",
    location: "天神",
    department: "トレーディング課",
    role: "PM",
    tmgEmail: "senba@timingood.co.jp",
    googleEmail: "miku.semba28@gmail.com",
  };
};
```

### 10.2 開発環境での動作フロー

```
1. localhostでアクセス
   ↓
2. isLocalhost()がtrueを返す
   ↓
3. AuthProviderでダミーユーザーを設定
   - createMockUser()
   - createMockEmployee()
   ↓
4. ログインページで自動的にダッシュボードにリダイレクト
   ↓
5. 認証チェックをスキップしてダッシュボードを表示
```

### 10.3 注意点

- 開発環境ではFirebase認証がスキップされるため、実際の認証フローをテストできない
- 本番環境での動作確認が必要
- ダミーユーザーの情報は固定値

---

## 11. デプロイ時の注意点

### 11.1 環境変数の設定

1. **Vercelの場合**:
   - プロジェクト設定 → Environment Variables
   - すべての`NEXT_PUBLIC_FIREBASE_*`環境変数を設定
   - 本番、プレビュー、開発環境それぞれに設定

2. **その他のホスティング**:
   - ホスティングサービスの環境変数設定画面で設定
   - `.env.local`は本番環境では使用しない

### 11.2 Firebase Consoleでの設定

1. **承認済みドメイン**:
   - 本番ドメインを追加（例: `your-domain.com`）
   - サブドメインも必要に応じて追加

2. **OAuth同意画面**:
   - Google Cloud Consoleで設定
   - アプリ名、サポートメール、ロゴなどを設定

### 11.3 ビルド時の注意

- 環境変数が設定されていない場合、Firebase初期化はスキップされる
- ビルド時エラーを防ぐため、エラーハンドリングが実装されている
- 本番環境では必ず環境変数を設定すること

---

## 12. 実装手順

### 12.1 新規プロジェクトへの実装手順

#### ステップ1: 依存関係のインストール

```bash
npm install firebase
```

#### ステップ2: 環境変数の設定

`.env.local`ファイルを作成し、Firebase設定を追加：

```bash
NEXT_PUBLIC_FIREBASE_API_KEY=your-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-auth-domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-storage-bucket
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your-messaging-sender-id
NEXT_PUBLIC_FIREBASE_APP_ID=your-app-id
```

#### ステップ3: Firebase初期化ファイルの作成

`lib/firebase.ts`を作成（上記のコードを参照）

#### ステップ4: 認証ユーティリティ関数の作成

`lib/auth.ts`を作成（上記のコードを参照）

#### ステップ5: 認証コンテキストの作成

`contexts/AuthContext.tsx`を作成（上記のコードを参照）

#### ステップ6: クライアント認証プロバイダーの作成

`components/ClientAuthProvider.tsx`を作成：

```typescript
"use client"

import { AuthProvider } from "@/contexts/AuthContext"

export function ClientAuthProvider({ children }: { children: React.ReactNode }) {
  return <AuthProvider>{children}</AuthProvider>
}
```

#### ステップ7: ルートレイアウトにプロバイダーを追加

`app/layout.tsx`を更新：

```typescript
import { ClientAuthProvider } from "@/components/ClientAuthProvider"

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ja">
      <body>
        <ClientAuthProvider>
          {children}
        </ClientAuthProvider>
      </body>
    </html>
  )
}
```

#### ステップ8: ログインページの作成

`app/login/page.tsx`を作成（上記のコードを参照）

#### ステップ9: API Routesの作成

1. `app/api/employees/check-email/route.ts`を作成
2. `app/api/employees/by-google-email/route.ts`を作成
3. BigQueryサービスを実装（社員マスタ検索）

#### ステップ10: 保護されたページの実装

認証が必要なページでは、`useAuth`フックを使用：

```typescript
"use client"

import { useAuth } from "@/contexts/AuthContext"
import { useRouter } from "next/navigation"
import { useEffect } from "react"

export default function ProtectedPage() {
  const { user, loading } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (!loading && !user) {
      router.push("/login")
    }
  }, [user, loading, router])

  if (loading) {
    return <div>Loading...</div>
  }

  if (!user) {
    return null
  }

  return <div>Protected Content</div>
}
```

### 12.2 既存プロジェクトへの統合

既存のNext.jsプロジェクトに統合する場合：

1. 上記のステップ1-10を実行
2. 既存の認証システムがある場合は、段階的に移行
3. 既存のAPI Routesと競合しないように注意
4. 既存のレイアウトに`ClientAuthProvider`を追加

### 12.3 テスト手順

1. **開発環境でのテスト**:
   - localhostでアクセス
   - ダミーユーザーで自動ログインされることを確認

2. **本番環境でのテスト**:
   - 環境変数を設定
   - Googleログインが動作することを確認
   - 社員マスタに存在するユーザーでログイン成功を確認
   - 社員マスタに存在しないユーザーでログイン失敗を確認
   - セッションタイムアウト（24時間）を確認

---

## 13. トラブルシューティング

### 13.1 よくある問題

#### 問題1: Firebase初期化エラー

**症状**: `Firebase認証が初期化されていません`エラー

**原因**:
- 環境変数が設定されていない
- 環境変数名が間違っている（`NEXT_PUBLIC_`プレフィックスが必要）

**解決方法**:
1. `.env.local`ファイルを確認
2. すべての`NEXT_PUBLIC_FIREBASE_*`環境変数が設定されているか確認
3. サーバーを再起動

#### 問題2: ポップアップがブロックされる

**症状**: ログインボタンをクリックしても何も起こらない

**原因**: ブラウザのポップアップブロッカー

**解決方法**:
1. ブラウザの設定でポップアップを許可
2. サイトを信頼済みサイトに追加

#### 問題3: 社員マスタに存在しないエラー

**症状**: ログイン時に「社員マスタに登録されていません」エラー

**原因**:
- BigQueryの`employees`テーブルにGoogleメールアドレスが登録されていない
- `google_email`カラムがNULL

**解決方法**:
1. BigQueryで`employees`テーブルを確認
2. 該当ユーザーの`google_email`カラムを更新

#### 問題4: セッションタイムアウトが動作しない

**症状**: 24時間経過してもログアウトされない

**原因**:
- `localStorage`が無効化されている
- ページ遷移が発生していない

**解決方法**:
1. ブラウザの開発者ツールで`localStorage`を確認
2. `lastSignInTime`が保存されているか確認
3. ページ遷移時にタイムアウトチェックが実行されるか確認

### 13.2 デバッグ方法

#### ログの確認

```typescript
// Firebase認証状態のログ
console.log('[Auth] Current user:', auth?.currentUser);

// 社員情報のログ
console.log('[Auth] Employee:', employee);

// セッションタイムアウトのログ
console.log('[Auth] Last sign in time:', localStorage.getItem('lastSignInTime'));
```

#### ブラウザの開発者ツール

1. **Applicationタブ**:
   - Local Storage → `lastSignInTime`を確認
   - Session Storage → 認証状態を確認

2. **Networkタブ**:
   - `/api/employees/check-email`のリクエスト/レスポンスを確認
   - Firebase認証のリクエストを確認

---

## 14. セキュリティ考慮事項

### 14.1 Firebase IDトークンの検証

他のサイトでFirebase IDトークンを使用する場合、サーバーサイドで検証が必要です：

```typescript
import { getAuth } from 'firebase-admin/auth';

const decodedToken = await getAuth().verifyIdToken(idToken);
const uid = decodedToken.uid;
const email = decodedToken.email;
```

### 14.2 環境変数の保護

- `.env.local`は`.gitignore`に追加
- 本番環境の環境変数は適切に管理
- Firebase APIキーは公開されても問題ないが、適切なドメイン制限を設定

### 14.3 CORS設定

API RoutesでCORSを適切に設定：

```typescript
function getCorsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*', // 本番環境では特定ドメインに制限
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
  }
}
```

---

## 15. 参考資料

### 15.1 Firebase公式ドキュメント

- [Firebase Authentication](https://firebase.google.com/docs/auth)
- [Firebase Authentication for Web](https://firebase.google.com/docs/auth/web/start)
- [Google Sign-In](https://firebase.google.com/docs/auth/web/google-signin)

### 15.2 Next.js公式ドキュメント

- [Environment Variables](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)

### 15.3 関連ドキュメント

- `docs/2026-01-15_TMG-Portal-SSO実装詳細仕様書.md`: SSO実装の詳細
- `docs/2026-01-15_TMG-Portal-SSO実装アーキテクチャ詳細.md`: SSOアーキテクチャ

---

## 16. まとめ

このドキュメントでは、TMG Portalで実装されているFirebase認証システムの詳細な仕様を説明しました。他のサイトに同様の認証システムを実装する際は、以下のポイントを確認してください：

1. **環境変数の設定**: すべての`NEXT_PUBLIC_FIREBASE_*`環境変数を設定
2. **Firebase Consoleの設定**: Google認証を有効化し、承認済みドメインを設定
3. **社員マスタ連携**: BigQueryの`employees`テーブルでメールアドレスを検証
4. **セッション管理**: 24時間のタイムアウトを実装
5. **エラーハンドリング**: 適切なエラーメッセージを表示
6. **開発環境**: localhostでの認証スキップ機能を実装

実装時に不明な点があれば、このドキュメントを参照してください。

---

**最終更新日**: 2026年1月23日  
**作成者**: AI Assistant  
**バージョン**: 1.0
