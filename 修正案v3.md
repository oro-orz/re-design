äº†è§£ã—ã¾ã—ãŸï¼ç¾åœ¨ã® v3 ã®å®Ÿè£…çŠ¶æ³ã‚’ç†è§£ã—ã¾ã—ãŸã€‚

---

## ç¾åœ¨ã® v3 ãƒ•ãƒ­ãƒ¼ï¼ˆç¢ºèªï¼‰

```
1. URLå…¥åŠ›
   â†“
2. AIåˆ†æï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æï¼‰
   â†“
3. è£œè¶³æƒ…å ±å…¥åŠ›ï¼ˆä»»æ„ï¼‰
   â†“
4. ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆææ¡ˆï¼ˆ6-8æšï¼‰
   â†“
5. å„ã‚¹ãƒ©ã‚¤ãƒ‰ã§ï¼š
   - ãƒ†ã‚­ã‚¹ãƒˆç¢ºèªãƒ»ç·¨é›†ï¼ˆmessage / subMessage / additionalTextï¼‰
   - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’1ã¤é¸æŠ
   - ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ â†’ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
```

---

## å•é¡Œç‚¹ï¼ˆå†ç¢ºèªï¼‰

**ç¾åœ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼š**
```
prompt_text: "Create a vertical 9:16 magazine-style educational advertisement 
image for a Japanese online course for mothers. Photography style: Studio 
photo... Subject: A Japanese mother and her young daughter..."
```

**å•é¡Œï¼š**
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã€Œè¦ªå­ã®å†™çœŸã€ãŒå›ºå®šã§æ›¸ã‹ã‚Œã¦ã„ã‚‹
- å©šæ´»æ¡ˆä»¶ã§ä½¿ã†ã¨ã€è¦ªå­ã®å†™çœŸãŒç”Ÿæˆã•ã‚Œã¦ã—ã¾ã†
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã¯è‰¯ã„ã®ã«ã€è¢«å†™ä½“ãŒåˆã‚ãªã„

**ã‚„ã‚ŠãŸã„ã“ã¨ï¼š**
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆé…è‰²ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒ•ã‚©ãƒ³ãƒˆï¼‰ã¯ä¿æŒ
- è¢«å†™ä½“ãƒ»ã‚·ãƒ¼ãƒ³ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã¯æ¡ˆä»¶ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ï¼‰ã«å¿œã˜ã¦å·®ã—æ›¿ãˆ

---

## è§£æ±ºç­–ï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹é€ åŒ–

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/011_template_structure_v3.sql`

```sql
-- prompt_templates ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ§‹é€ åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
ALTER TABLE prompt_templates
ADD COLUMN IF NOT EXISTS is_structured BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS style_json JSONB,
ADD COLUMN IF NOT EXISTS slots_json JSONB;

-- is_structured:
--   false = å¾“æ¥å‹ï¼ˆprompt_text ã‚’ãã®ã¾ã¾ä½¿ç”¨ã€ãƒ†ã‚­ã‚¹ãƒˆç½®æ›ã®ã¿ï¼‰
--   true = æ§‹é€ åŒ–å‹ï¼ˆstyle_json + slots_json ã‚’ä½¿ç”¨ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å‹•çš„ç”Ÿæˆï¼‰

-- style_json ã®æ§‹é€ ä¾‹:
-- {
--   "photography": "Studio photo with natural sunlight, soft and even lighting",
--   "lighting": "Natural light through window, warm atmosphere",
--   "designStyle": "Clean and modern, ample white space, balanced typography",
--   "layout": "Vertical 9:16, text overlay at top-left, center banner, bottom stats",
--   "typography": "Handwritten-style for emotional text, bold sans-serif for banner",
--   "colors": "Soft pastel: mint green, pale yellow, white, orange accents",
--   "decorations": ["Green banner for main message", "White boxes for stats"],
--   "mood": "Friendly, educational, encouraging, professional"
-- }

-- slots_json ã®æ§‹é€ ä¾‹:
-- {
--   "textSlots": [
--     {"id": "topLeft", "description": "æ„Ÿæƒ…çš„ãªå…±æ„Ÿãƒ•ãƒ¬ãƒ¼ã‚º"},
--     {"id": "centerBanner", "description": "ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"},
--     {"id": "mainCopy", "description": "å…·ä½“çš„ãªè¨´æ±‚"},
--     {"id": "stats", "description": "çµ±è¨ˆãƒ»å®Ÿç¸¾ï¼ˆä»»æ„ï¼‰"}
--   ]
-- }

COMMENT ON COLUMN prompt_templates.is_structured IS 'true=æ§‹é€ åŒ–å‹, false=å¾“æ¥å‹';
COMMENT ON COLUMN prompt_templates.style_json IS 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼ˆæ§‹é€ åŒ–å‹ã®ã¿ï¼‰';
COMMENT ON COLUMN prompt_templates.slots_json IS 'ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ­ãƒƒãƒˆå®šç¾©ï¼ˆæ§‹é€ åŒ–å‹ã®ã¿ï¼‰';
```

---

### 2. å‹å®šç¾©ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `types/swipe-lp-v3.ts`

æ—¢å­˜ã® `PromptTemplate` ã«è¿½åŠ ï¼š

```typescript
export interface PromptTemplate {
  id: string;
  name: string;
  sample_image_url?: string;
  image_urls?: string[];
  category?: string;
  memo?: string;
  
  // å¾“æ¥å‹
  base_prompt?: string;
  prompt_text?: string;
  
  // ğŸ†• æ§‹é€ åŒ–å‹
  is_structured?: boolean;
  style_json?: TemplateStyle;
  slots_json?: TemplateSlots;
}

export interface TemplateStyle {
  photography: string;
  lighting: string;
  designStyle: string;
  layout: string;
  typography: string;
  colors: string;
  decorations: string[];
  mood: string;
}

export interface TemplateSlots {
  textSlots: TextSlot[];
}

export interface TextSlot {
  id: string;           // 'topLeft', 'centerBanner', 'mainCopy', 'stats'
  description: string;  // 'æ„Ÿæƒ…çš„ãªå…±æ„Ÿãƒ•ãƒ¬ãƒ¼ã‚º'
}
```

---

### 3. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆé–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/swipe-lp/gaudi/prompts/content-for-template.ts`

```typescript
import { openai } from '@/lib/openai';
import type { SwipeLPv3Slide, MarketingAnalysis, TemplateSlots } from '@/types/swipe-lp-v3';

/**
 * ã‚¹ãƒ©ã‚¤ãƒ‰ã¨ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æã‹ã‚‰ã€
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã®è¢«å†™ä½“ãƒ»ã‚·ãƒ¼ãƒ³ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
 */
export async function generateContentForTemplate(
  slide: SwipeLPv3Slide,
  analysis: MarketingAnalysis,
  slots: TemplateSlots,
  excludePerson: boolean = false
): Promise<{
  subject: string;
  scene: string;
  texts: Record<string, string>;
}> {
  
  // ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ­ãƒƒãƒˆã®èª¬æ˜ã‚’æ•´å½¢
  const slotsDescription = slots.textSlots
    .map(slot => `- ${slot.id}: ${slot.description}`)
    .join('\n');
  
  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [{
      role: "system",
      content: `ã‚ãªãŸã¯åºƒå‘Šãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚

## ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æ
- ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—: ${analysis.businessType}
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${analysis.target}
- æ„Ÿæƒ…ãƒˆãƒªã‚¬ãƒ¼: ${analysis.emotionalTrigger}

## ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹
- ç›®çš„: ${slide.purpose}
- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${slide.message}
- ã‚µãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${slide.subMessage || 'ãªã—'}
- è¿½åŠ ãƒ†ã‚­ã‚¹ãƒˆ: ${slide.additionalText?.join(', ') || 'ãªã—'}
- æ„Ÿæƒ…: ${slide.emotion || 'ãªã—'}

## äººç‰©è¡¨ç¤º
${excludePerson ? 'âŒ äººç‰©ãªã—ï¼ˆå‹•ç”»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ï¼‰' : 'âœ… äººç‰©ã‚ã‚Š'}

## ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ­ãƒƒãƒˆ
${slotsDescription}

## å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰

{
  "subject": "${excludePerson ? 'ãªã—ï¼ˆèƒŒæ™¯ã®ã¿ï¼‰' : 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã‚’è¡¨ç¾ã™ã‚‹äººç‰©ã®è©³ç´°ãªè‹±èªæå†™'}",
  "scene": "ã‚·ãƒ¼ãƒ³ã®è©³ç´°ãªè‹±èªæå†™ï¼ˆå ´æ‰€ãƒ»é›°å›²æ°—ãƒ»èƒŒæ™¯ï¼‰",
  "texts": {
    "topLeft": "å·¦ä¸Šãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªï¼‰",
    "centerBanner": "ä¸­å¤®ãƒãƒŠãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªï¼‰",
    "mainCopy": "ãƒ¡ã‚¤ãƒ³ã‚³ãƒ”ãƒ¼ï¼ˆæ—¥æœ¬èªï¼‰",
    "stats": "çµ±è¨ˆãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªã€ä»»æ„ï¼‰"
  }
}

## é‡è¦ãªæŒ‡é‡

### è¢«å†™ä½“ï¼ˆsubjectï¼‰è‹±èªã§è©³ç´°ã«
${excludePerson ? `
- äººç‰©ã¯å«ã‚ãªã„
- ä»£ã‚ã‚Šã«è±¡å¾´çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ç©ºé–“ã‚’å¼·èª¿
- ä¾‹: "Empty modern workspace with laptop and coffee on wooden desk, soft natural lighting"
` : `
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ï¼ˆ${analysis.target}ï¼‰ã‚’è¦–è¦šçš„ã«è¡¨ç¾
- å¹´é½¢ãƒ»æ€§åˆ¥ãƒ»æœè£…ãƒ»è¡¨æƒ…ãƒ»ãƒãƒ¼ã‚ºã‚’è‹±èªã§å…·ä½“çš„ã«
- ä¾‹: "A Japanese woman in her early 30s with shoulder-length brown hair, wearing a casual white blouse, smiling confidently"
`}

### ã‚·ãƒ¼ãƒ³ï¼ˆsceneï¼‰è‹±èªã§è©³ç´°ã«
- ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆ${analysis.businessType}ï¼‰ã«åˆã£ãŸå ´æ‰€
- ä¾‹: "Modern cafÃ© interior with large windows, natural light, wooden tables, warm and inviting atmosphere"

### ãƒ†ã‚­ã‚¹ãƒˆï¼ˆtextsï¼‰æ—¥æœ¬èªã§
- å„ã‚¹ãƒ­ãƒƒãƒˆã®èª¬æ˜ã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
- ã‚¹ãƒ©ã‚¤ãƒ‰ã® message / subMessage / additionalText ã‚’æ´»ç”¨
- åºƒå‘Šã‚³ãƒ”ãƒ¼ã¨ã—ã¦è‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾

å¿…ãšJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚`
    }],
    response_format: { type: "json_object" },
    temperature: 0.7
  });
  
  const result = JSON.parse(response.choices[0].message.content!);
  console.log('[generateContentForTemplate] Generated:', result);
  
  return result;
}
```

---

### 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦é–¢æ•°

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/swipe-lp/gaudi/prompts/assemble-structured.ts`

```typescript
import type { PromptTemplate } from '@/types/swipe-lp-v3';

/**
 * æ§‹é€ åŒ–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â†’ æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
export function assembleStructuredPrompt(
  template: PromptTemplate,
  content: {
    subject: string;
    scene: string;
    texts: Record<string, string>;
  },
  excludePerson: boolean = false
): string {
  
  if (!template.style_json || !template.slots_json) {
    throw new Error('Structured template requires style_json and slots_json');
  }
  
  const style = template.style_json;
  
  // ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ§‹ç¯‰
  let textOverlay = "";
  
  if (content.texts.topLeft) {
    textOverlay += `\nIn the top left, handwritten-style text in black reads ã€Œ${content.texts.topLeft}ã€.`;
  }
  
  if (content.texts.centerBanner) {
    textOverlay += `\nIn the center, within a green banner, bold white text states ã€Œ${content.texts.centerBanner}ã€.`;
  }
  
  if (content.texts.mainCopy) {
    textOverlay += `\nBelow, larger black text in a modern sans-serif font reads "${content.texts.mainCopy}".`;
  }
  
  if (content.texts.stats) {
    textOverlay += `\nAt the bottom, white boxes with orange text highlight key points: "${content.texts.stats}".`;
  }
  
  // æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  let prompt = `
Create a vertical 9:16 magazine-style advertisement image.

Photography style: ${style.photography}

${!excludePerson && content.subject ? `Subject: ${content.subject}` : ''}

Main scene: ${content.scene}

Text overlay:${textOverlay}

Design style: ${style.designStyle}

Layout: ${style.layout}

Typography: ${style.typography}

Colors & mood: ${style.colors}

${style.decorations.length > 0 ? `Decorations: ${style.decorations.join(", ")}` : ''}

Overall mood: ${style.mood}

Avoid: CTA, call-to-action, CTA button, CTA text

Aspect ratio: 9:16.
  `.trim();
  
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰
  if (excludePerson) {
    const OVERLAY_PREFIX = `OVERLAY MODE (for video): Remove only the subject/person and the photographed scene. Replace the background with solid color or minimal gradient for easy masking. Keep the same composition: layout structure, text overlay positions and styles, decorative elements, color palette, design style. Identical to the design except the photo is removed.

`;
    prompt = OVERLAY_PREFIX + prompt;
  }
  
  return prompt;
}

/**
 * å¾“æ¥å‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆç½®æ›ï¼‰
 */
export function assembleTraditionalPrompt(
  template: PromptTemplate,
  slide: SwipeLPv3Slide,
  excludePerson: boolean = false
): string {
  
  let baseText = template.prompt_text || template.base_prompt || '';
  
  // ã€Œ...ã€ã‚’é †ã«ç½®æ›
  const texts = [
    slide.message,
    slide.subMessage || '',
    ...(slide.additionalText || [])
  ].filter(Boolean);
  
  let replacementIndex = 0;
  baseText = baseText.replace(/ã€Œ[^ã€]*ã€/g, (match) => {
    if (replacementIndex < texts.length) {
      return `ã€Œ${texts[replacementIndex++]}ã€`;
    }
    return match;
  });
  
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰
  if (excludePerson) {
    const OVERLAY_PREFIX = `OVERLAY MODE (for video): Remove only the subject/person and the photographed scene. Replace the background with solid color or minimal gradient for easy masking. Keep the same composition: layout structure, text overlay positions and styles, decorative elements, color palette, design style. Identical to the design except the photo is removed.

`;
    baseText = OVERLAY_PREFIX + baseText;
  }
  
  return baseText;
}
```

---

### 5. Server Action ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `actions/swipe-lp-v3.ts`

æ—¢å­˜ã® `generateSlidePrompt` é–¢æ•°ã‚’æ›´æ–°ï¼š

```typescript
import { generateContentForTemplate } from '@/lib/swipe-lp/gaudi/prompts/content-for-template';
import { assembleStructuredPrompt, assembleTraditionalPrompt } from '@/lib/swipe-lp/gaudi/prompts/assemble-structured';

/**
 * ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
 */
export async function generateSlidePrompt(
  projectId: string,
  slideId: string
) {
  "use server";
  
  try {
    console.log('[generateSlidePrompt] Starting:', { projectId, slideId });
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
    const { data: project, error: projectError } = await supabase
      .from("swipe_lp_v3_projects")
      .select("*")
      .eq("id", projectId)
      .single();
    
    if (projectError || !project) {
      return { error: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };
    }
    
    // ã‚¹ãƒ©ã‚¤ãƒ‰å–å¾—
    const slide = project.slides.find((s: SwipeLPv3Slide) => s.id === slideId);
    if (!slide) {
      return { error: "ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—
    if (!slide.selected_template_id) {
      return { error: "ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“" };
    }
    
    const { data: template, error: templateError } = await supabase
      .from("prompt_templates")
      .select("*")
      .eq("id", slide.selected_template_id)
      .single();
    
    if (templateError || !template) {
      return { error: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };
    }
    
    let finalPrompt: string;
    
    // æ§‹é€ åŒ– vs å¾“æ¥å‹ã®åˆ¤å®š
    if (template.is_structured && template.style_json && template.slots_json) {
      // ğŸ†• æ§‹é€ åŒ–å‹ï¼šè¢«å†™ä½“ãƒ»ã‚·ãƒ¼ãƒ³ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ç”Ÿæˆ
      console.log('[generateSlidePrompt] Using structured template');
      
      const content = await generateContentForTemplate(
        slide,
        project.marketing_analysis,
        template.slots_json,
        slide.excludePerson || false
      );
      
      finalPrompt = assembleStructuredPrompt(
        template,
        content,
        slide.excludePerson || false
      );
      
    } else {
      // å¾“æ¥å‹ï¼šãƒ†ã‚­ã‚¹ãƒˆç½®æ›ã®ã¿
      console.log('[generateSlidePrompt] Using traditional template');
      
      finalPrompt = assembleTraditionalPrompt(
        template,
        slide,
        slide.excludePerson || false
      );
    }
    
    // ã‚¹ãƒ©ã‚¤ãƒ‰æ›´æ–°
    const updatedSlides = project.slides.map((s: SwipeLPv3Slide) =>
      s.id === slideId
        ? {
            ...s,
            prompt: finalPrompt,
            promptGeneratedAt: new Date().toISOString()
          }
        : s
    );
    
    await supabase
      .from("swipe_lp_v3_projects")
      .update({ slides: updatedSlides })
      .eq("id", projectId);
    
    console.log('[generateSlidePrompt] Success');
    return { success: true, prompt: finalPrompt };
    
  } catch (err) {
    console.error('[generateSlidePrompt] Error:', err);
    return {
      error: err instanceof Error ? err.message : "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
    };
  }
}
```

---

### 6. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†UIã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/library/manage/page.tsx`

ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã« **æ§‹é€ åŒ–å‹** ã‚’é¸æŠå¯èƒ½ã«ï¼š

```typescript
"use client";

import { useState } from "react";
import { uploadAndAnalyzeImages } from "@/actions/library";

export default function LibraryManagePage() {
  const [isStructured, setIsStructured] = useState(true);
  
  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†</h1>
      
      {/* æ§‹é€ åŒ– vs å¾“æ¥å‹ */}
      <div className="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6">
        <h2 className="font-bold mb-4">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒ—</h2>
        
        <div className="space-y-3">
          <label className="flex items-start gap-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-black">
            <input
              type="radio"
              checked={isStructured}
              onChange={() => setIsStructured(true)}
              className="mt-1"
            />
            <div>
              <div className="font-bold">âœ¨ æ§‹é€ åŒ–å‹ï¼ˆæ¨å¥¨ï¼‰</div>
              <div className="text-sm text-gray-600 mt-1">
                ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿ã¡ãªãŒã‚‰ã€æ¡ˆä»¶ã”ã¨ã«äººç‰©ãƒ»ã‚·ãƒ¼ãƒ³ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•èª¿æ•´
              </div>
              <div className="text-xs text-green-600 mt-2">
                ğŸ’¡ Fammé¢¨ã®ãƒ‘ã‚¹ãƒ†ãƒ«é…è‰²ã§ã€å©šæ´»æ¡ˆä»¶ã®äººç‰©ã«å¤‰æ›´ ãªã©
              </div>
            </div>
          </label>
          
          <label className="flex items-start gap-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
            <input
              type="radio"
              checked={!isStructured}
              onChange={() => setIsStructured(false)}
              className="mt-1"
            />
            <div>
              <div className="font-bold">ğŸ“ å¾“æ¥å‹</div>
              <div className="text-sm text-gray-600 mt-1">
                ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨ã€ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã ã‘ç½®æ›
              </div>
            </div>
          </label>
        </div>
      </div>
      
      {/* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
      <div className="bg-white border-2 border-gray-200 rounded-xl p-6">
        <h2 className="font-bold mb-4">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        
        <input
          type="file"
          multiple
          accept="image/*"
          onChange={async (e) => {
            const files = Array.from(e.target.files || []);
            if (files.length > 0) {
              await uploadAndAnalyzeImages(files, isStructured);
              alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');
            }
          }}
          className="w-full"
        />
      </div>
    </div>
  );
}
```

---

### 7. ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Server Action ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `actions/library.ts`

```typescript
export async function uploadAndAnalyzeImages(
  files: File[],
  isStructured: boolean = true
) {
  "use server";
  
  const results = [];
  
  for (const file of files) {
    try {
      // 1. ç”»åƒã‚’Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const imageUrl = await uploadImageToStorage(file);
      
      if (isStructured) {
        // ğŸ†• æ§‹é€ åŒ–å‹ï¼šã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆ†é›¢
        const analysis = await analyzeImageForStructured(imageUrl);
        
        const { data, error } = await supabase
          .from("prompt_templates")
          .insert({
            name: analysis.name || `AIç”Ÿæˆ-${Date.now()}`,
            sample_image_url: imageUrl,
            is_structured: true,
            style_json: analysis.style_json,
            slots_json: analysis.slots_json,
            category: analysis.category,
            memo: analysis.memo,
          })
          .select()
          .single();
        
        if (error) throw error;
        results.push(data);
        
      } else {
        // å¾“æ¥å‹ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä¿å­˜
        const analysis = await analyzeImageForTraditional(imageUrl);
        
        const { data, error } = await supabase
          .from("prompt_templates")
          .insert({
            name: analysis.name || `AIç”Ÿæˆ-${Date.now()}`,
            sample_image_url: imageUrl,
            is_structured: false,
            prompt_text: analysis.prompt_text,
            category: analysis.category,
            memo: analysis.memo,
          })
          .select()
          .single();
        
        if (error) throw error;
        results.push(data);
      }
      
    } catch (err) {
      console.error('[uploadAndAnalyzeImages] Error:', err);
    }
  }
  
  return { success: true, count: results.length };
}

/**
 * ğŸ†• ç”»åƒã‚’æ§‹é€ åŒ–å½¢å¼ã§åˆ†æ
 */
async function analyzeImageForStructured(imageUrl: string) {
  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [{
      role: "user",
      content: [
        { type: "image_url", image_url: { url: imageUrl } },
        {
          type: "text",
          text: `ã“ã®åºƒå‘Šç”»åƒã‚’åˆ†æã—ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

{
  "name": "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåï¼ˆFammé¢¨ãƒ‘ã‚¹ãƒ†ãƒ«ã€ãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ£ãƒ¼ãƒ—ãªã©ï¼‰",
  "category": "æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒªï¼ˆå©šæ´»/è»¢è·/EC/æ•™è‚²/æ±ç”¨ï¼‰",
  "memo": "ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´ï¼ˆUGCæ„Ÿ/é›‘èªŒé¢¨/é«˜ç´šæ„Ÿãªã©ï¼‰",
  "style_json": {
    "photography": "æ’®å½±ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè‹±èªï¼‰",
    "lighting": "ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ï¼ˆè‹±èªï¼‰",
    "designStyle": "ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè‹±èªï¼‰",
    "layout": "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ ï¼ˆè‹±èªï¼‰",
    "typography": "ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ï¼ˆè‹±èªï¼‰",
    "colors": "é…è‰²ãƒ»ãƒ ãƒ¼ãƒ‰ï¼ˆè‹±èªï¼‰",
    "decorations": ["è£…é£¾è¦ç´ 1", "è£…é£¾è¦ç´ 2"],
    "mood": "å…¨ä½“ã®é›°å›²æ°—ï¼ˆè‹±èªï¼‰"
  },
  "slots_json": {
    "textSlots": [
      {"id": "topLeft", "description": "å·¦ä¸Šãƒ†ã‚­ã‚¹ãƒˆã®å½¹å‰²"},
      {"id": "centerBanner", "description": "ä¸­å¤®ãƒãƒŠãƒ¼ã®å½¹å‰²"},
      {"id": "mainCopy", "description": "ãƒ¡ã‚¤ãƒ³ã‚³ãƒ”ãƒ¼ã®å½¹å‰²"}
    ]
  }
}

é‡è¦ï¼š
- è¢«å†™ä½“ï¼ˆäººç‰©ãƒ»å•†å“ï¼‰ã¨ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¯é™¤å¤–
- ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ï¼ˆé…è‰²ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒ•ã‚©ãƒ³ãƒˆãƒ»è£…é£¾ï¼‰ã ã‘ã‚’è¨˜è¿°
- å†åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ã‚’ä½œæˆ`
        }
      ]
    }],
    response_format: { type: "json_object" }
  });
  
  return JSON.parse(response.choices[0].message.content!);
}

/**
 * å¾“æ¥å‹ï¼šç”»åƒã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
 */
async function analyzeImageForTraditional(imageUrl: string) {
  // æ—¢å­˜ã® analyzeImage é–¢æ•°ã‚’ä½¿ç”¨
  return await analyzeImage(imageUrl);
}
```

---

## ä½¿ç”¨ä¾‹

### Fammé¢¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæ§‹é€ åŒ–å‹ï¼‰ã‚’å©šæ´»æ¡ˆä»¶ã§ä½¿ç”¨

```
1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†ã§ Famm ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ§‹é€ åŒ–å‹ï¼‰
   â†’ AI ãŒã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ã‚’æŠ½å‡º
   
2. å©šæ´»æ¡ˆä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
   â†’ ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æï¼ˆãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—: å©šæ´»ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ—ãƒªï¼‰
   
3. ã‚¹ãƒ©ã‚¤ãƒ‰1ã€Œèª²é¡Œæèµ·ã€
   - message: "å‡ºä¼šã„ãŒãªã„...ãã‚“ãªæ‚©ã¿ã€ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ"
   - Fammé¢¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ
   - ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³
   
4. AI ãŒè‡ªå‹•ç”Ÿæˆï¼š
   - è¢«å†™ä½“: "A Japanese woman in her early 30s, wearing professional attire, 
              looking slightly worried while checking her smartphone"
   - ã‚·ãƒ¼ãƒ³: "Modern office cafÃ©, large windows with city view, warm lighting"
   - ãƒ†ã‚­ã‚¹ãƒˆ: ã€Œå¿™ã—ã„æ¯æ—¥ã®ä¸­ã§ã€å‡ºä¼šã„ã®æ©Ÿä¼šã‚’é€ƒã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿã€
   
5. æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š
   - ãƒ‘ã‚¹ãƒ†ãƒ«é…è‰²ï¼ˆFammé¢¨ï¼‰
   - äººç‰©ã¯30ä»£å¥³æ€§ï¼ˆå©šæ´»æ¡ˆä»¶ï¼‰
   - ã‚·ãƒ¼ãƒ³ã¯ã‚ªãƒ•ã‚£ã‚¹ã‚«ãƒ•ã‚§ï¼ˆå©šæ´»æ¡ˆä»¶ï¼‰
```

---

## ã¾ã¨ã‚

### âœ… ã“ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆ

1. **æ—¢å­˜ã® v3 ãƒ•ãƒ­ãƒ¼ã¯ãã®ã¾ã¾**
   - URLå…¥åŠ› â†’ åˆ†æ â†’ ã‚¹ãƒ©ã‚¤ãƒ‰ç·¨é›† â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ â†’ ç”Ÿæˆ

2. **å¾Œæ–¹äº’æ›æ€§**
   - å¾“æ¥å‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚å¼•ãç¶šãå‹•ä½œ

3. **æ®µéšçš„ç§»è¡Œ**
   - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†ã§ã€Œæ§‹é€ åŒ–å‹ã€ã‚’é¸ã¶ã ã‘

4. **Fammé¢¨ â†’ å©šæ´»ã®å¤‰æ›**
   - ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä¿æŒ
   - äººç‰©ãƒ»ã‚·ãƒ¼ãƒ³ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã¯è‡ªå‹•èª¿æ•´

å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚è¨­è¨ˆã®ä¿®æ­£ç‚¹ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ