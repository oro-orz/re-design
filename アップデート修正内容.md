## 実装準備チェックリスト

### 1. まず現状確認（5分）

既存システムの状態を確認しましょう：

```bash
# プロジェクトルートで実行
ls -la

# 現在のファイル構造を確認
tree -L 3 -I 'node_modules'

# データベースの状態確認
# Supabase Studioで swipe_lp_projects テーブルが存在するか
```

---

### 2. 段階的移行戦略（推奨）

**❌ 避けるべき：全面書き換え**
- リスク大
- デバッグ困難
- ロールバック不可

**✅ 推奨：段階的追加**
```
既存システム（保持）
    ↓
Phase 1: マーケ分析追加（新機能）
    ↓
Phase 2: スタイルライブラリ追加（新機能）
    ↓
Phase 3: 統合・旧コード削除
```

---

### 3. 今すぐ実行すべきこと

#### Step 1: ブランチ作成（1分）

```bash
# 現在の作業を保存
git add .
git commit -m "feat: 現行システム（Phase 0）"

# 新機能ブランチ作成
git checkout -b feature/gaudi-2.0

# または、安全のためバックアップブランチも
git checkout -b backup/current-system
git checkout main
git checkout -b feature/gaudi-2.0
```

#### Step 2: 環境変数確認（2分）

`.env.local` に以下が揃っているか確認：

```bash
# 必須
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
OPENAI_API_KEY=

# Gaudí 2.0で必要
GOOGLE_VISION_API_KEY=  # ← これあるか確認
MAX_OCR_IMAGES=5        # ← 任意、なければデフォルト5

# 確認コマンド
cat .env.local | grep -E "(OPENAI|GOOGLE_VISION|SUPABASE)"
```

**Google Vision APIキーがない場合：**
1. https://console.cloud.google.com/apis/credentials
2. API キーを作成
3. Vision API を有効化
4. `.env.local` に追加

#### Step 3: 依存関係追加（3分）

```bash
# 新しく必要なパッケージをインストール
npm install js-yaml cheerio @types/js-yaml @types/cheerio

# 確認
npm list | grep -E "(yaml|cheerio)"
```

---

### 4. ディレクトリ構造の準備（5分）

```bash
# 新しいディレクトリを作成
mkdir -p lib/design-system/{atoms,molecules,compiler}
mkdir -p lib/marketing
mkdir -p lib/prompts

# 構造確認
tree lib -L 2
```

期待される構造：
```
lib/
├── design-system/
│   ├── atoms/           # 色・フォント・レイアウトの原子
│   ├── molecules/       # スタイル分子（YAML）
│   └── compiler/        # プロンプト生成エンジン
├── marketing/           # マーケティング分析
├── prompts/             # LLMプロンプトテンプレート
├── fetch-html.ts        # 既存（保持）
├── ocr-google.ts        # 既存（保持）
└── analyzer.ts          # 既存（保持）
```

---

### 5. データベースマイグレーション（5分）

既存の `swipe_lp_projects` テーブルに列を追加：

```sql
-- supabase/migrations/007_gaudi_2.0_fields.sql
-- マーケティング分析フィールド追加
ALTER TABLE swipe_lp_projects
ADD COLUMN IF NOT EXISTS marketing_analysis JSONB;

-- スライドの構造を拡張（variants配列を追加）
-- 既存のslidesカラムはそのまま、互換性を保つ

-- 新テーブル：デザインスタイルライブラリ
CREATE TABLE IF NOT EXISTS design_styles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  author_id UUID REFERENCES auth.users,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  yaml_content TEXT NOT NULL,
  
  tags TEXT[],
  category TEXT,
  
  usage_count INT DEFAULT 0,
  rating NUMERIC(3,2),
  
  is_public BOOLEAN DEFAULT false,
  is_official BOOLEAN DEFAULT false
);

-- 新テーブル：スタイル使用履歴
CREATE TABLE IF NOT EXISTS style_usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES swipe_lp_projects,
  slide_number INT,
  style_id TEXT REFERENCES design_styles,
  business_type TEXT,
  target_audience TEXT,
  was_selected BOOLEAN,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX IF NOT EXISTS idx_design_styles_category ON design_styles(category);
CREATE INDEX IF NOT EXISTS idx_design_styles_tags ON design_styles USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_style_usage_logs_project ON style_usage_logs(project_id);
```

実行方法：
```bash
# Supabase CLI使用の場合
supabase migration new gaudi_2_0_fields

# または Supabase Studio の SQL Editor で直接実行
```

---

### 6. Cursor への指示準備（10分）

以下のファイルを作成して、Cursorに渡す：

#### `IMPLEMENTATION_PLAN.md`

```markdown
# Gaudí 2.0 実装計画

## Phase 1: マーケティング分析エンジン（Week 1-2）

### 実装ファイル
1. `lib/marketing/analyzer.ts` - マーケティング分析メインロジック
2. `lib/marketing/frameworks.ts` - 3C・AIDMA等のフレームワーク定義
3. `lib/prompts/marketing-analysis.ts` - LLMプロンプトテンプレート

### 既存ファイルの再利用
- `lib/fetch-html.ts` - そのまま使用
- `lib/ocr-google.ts` - そのまま使用
- `lib/analyzer.ts` - extractImages/extractTextFromHtml を使用

### 新規API
- `runMarketingAnalysis(projectId, inputType, url?, imageFile?)` → MarketingAnalysis

### 型定義
```typescript
interface MarketingAnalysis {
  businessType: string;
  target: string;
  painPoints: string[];
  solution: string;
  emotionalTrigger: string;
  framework: {
    "3C": { customer: string; competitor: string; company: string };
    "AIDMA": { attention: string; interest: string; desire: string; memory: string; action: string };
  };
}
```

### テスト方法
- 入力: https://www.pairs.lv/（婚活サイト）
- 期待出力: businessType="婚活マッチングアプリ", target="25-35歳独身女性"

---

## Phase 2: スライド構成生成（Week 2-3）

### 実装ファイル
1. `lib/slides/structure-generator.ts`
2. `lib/prompts/slide-structure.ts`

### 新規API
- `generateSlideStructure(analysis: MarketingAnalysis)` → Slide[]

### 型定義
```typescript
interface Slide {
  number: number;
  purpose: "課題提起" | "ソリューション" | "ベネフィット" | "社会的証明" | "CTA";
  message: string;
  subMessage?: string;
  emotion: string;
}
```

---

## Phase 3: デザインスタイルシステム（Week 3-5）

### 実装ファイル
1. `lib/design-system/atoms/colors.ts` - 50色の原子定義
2. `lib/design-system/atoms/typography.ts` - 20タイポグラフィ原子
3. `lib/design-system/atoms/layouts.ts` - 15レイアウト原子
4. `lib/design-system/compiler/prompt-compiler.ts` - プロンプト生成
5. `lib/design-system/molecules/styles/retro-80s.yaml` - 最初のスタイル定義

### 優先実装スタイル（10個）
1. retro-80s
2. minimal-pastel
3. pop-comic
4. brutalism
5. luxury-gold
6. corporate-blue
7. y2k-chrome
8. kawaii-pink
9. cyberpunk-neon
10. swiss-grid

---

## Phase 4: UI実装（Week 5-7）

### 新規ページ
- `app/swipe-lp/[id]/page.tsx` - プロジェクト詳細（スタイル選択UI）

### 既存ページの拡張
- `app/swipe-lp/new/page.tsx` - 入力UIはそのまま、createSwipeLPProject関数を拡張

### Server Actions拡張
- `actions/swipe-lp.ts`
  - `createAndAnalyzeProject()` - Phase 1-3を統合実行
  - `saveStyleSelection()` - ユーザー選択を保存
  - `exportPrompts()` - プロンプト一括エクスポート

---

## 実装順序（優先度）

### Week 1: 最小限のプロトタイプ
1. ✅ マーケティング分析（3C・AIDMAなし、シンプル版）
2. ✅ スライド構成生成（6枚固定）
3. ✅ 1スタイルだけ実装（minimal-pastel）
4. ✅ プロンプト生成・表示

### Week 2-3: スタイルバリエーション
5. ⬜ 原子ライブラリ構築（20個の原子）
6. ⬜ 3スタイル追加（retro-80s, pop-comic, luxury-gold）
7. ⬜ スタイル選択UI

### Week 4-5: 完全版
8. ⬜ 残り6スタイル追加
9. ⬜ AI自動スタイル選定
10. ⬜ エクスポート機能

### Week 6-7: 最適化・テスト
11. ⬜ パフォーマンス最適化
12. ⬜ エラーハンドリング
13. ⬜ ユーザーテスト

### Week 8: リリース準備
14. ⬜ ドキュメント
15. ⬜ デモ動画
16. ⬜ 本番デプロイ
```

---

### 7. Cursor に最初のタスクを依頼

Cursorを開いて、以下を貼り付け：

```
# タスク: Gaudí 2.0 Phase 1 実装

## 背景
既存のスワイプLP生成システムに、マーケティング分析機能を追加します。
既存コード（fetch-html.ts, ocr-google.ts, analyzer.ts）は保持し、新機能を追加する形で実装してください。

## 実装内容

### 1. 型定義の追加
`types/swipe-lp.ts` に以下の型を追加：

```typescript
export interface MarketingAnalysis {
  businessType: string;
  target: string;
  painPoints: string[];
  solution: string;
  emotionalTrigger: string;
  framework: {
    "3C": {
      customer: string;
      competitor: string;
      company: string;
    };
    "AIDMA": {
      attention: string;
      interest: string;
      desire: string;
      memory: string;
      action: string;
    };
  };
}

export interface SwipeLPProject {
  // 既存フィールドはそのまま
  id: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  input_type: "url" | "image";
  input_url?: string;
  input_image_url?: string;
  slides: Slide[];
  status: "draft" | "analyzing" | "design_selection" | "ready" | "completed";
  project_name: string;
  
  // 新規フィールド
  marketing_analysis?: MarketingAnalysis;
}
```

### 2. マーケティング分析関数の実装
新規ファイル `lib/marketing/analyzer.ts` を作成：

```typescript
import { openai } from '@/lib/openai';
import { fetchHtml } from '@/lib/fetch-html';
import { extractImages, extractTextFromHtml } from '@/lib/analyzer';
import { runGoogleVisionOCR } from '@/lib/ocr-google';
import type { MarketingAnalysis } from '@/types/swipe-lp';

export async function runMarketingAnalysis(
  inputType: "url" | "image",
  url?: string,
  imageFile?: File
): Promise<MarketingAnalysis> {
  // 1. コンテンツ取得
  let htmlText = '';
  let imageUrls: string[] = [];
  let ocrTexts: string[] = [];
  
  if (inputType === "url") {
    // URLの場合
    const html = await fetchHtml(url!);
    htmlText = extractTextFromHtml(html);
    const images = extractImages(html, url!);
    imageUrls = images.slice(0, 5).map(img => img.url);
    
    // 主要画像のOCR
    if (process.env.GOOGLE_VISION_API_KEY) {
      const ocrResults = await Promise.all(
        imageUrls.map(imgUrl => 
          runGoogleVisionOCR({ imageUrl: imgUrl }).catch(() => '')
        )
      );
      ocrTexts = ocrResults.filter(Boolean);
    }
  } else {
    // 画像アップロードの場合
    const base64 = await fileToBase64(imageFile!);
    const ocrText = await runGoogleVisionOCR({ imageContent: base64 });
    ocrTexts = [ocrText];
  }
  
  // 2. GPT-4oで分析
  const prompt = `あなたはマーケティング戦略コンサルタントです。
以下のコンテンツを分析し、マーケティングフレームワークを適用してください。

## 分析対象
HTMLテキスト:
${htmlText}

OCRテキスト:
${ocrTexts.join('\n\n')}

## 出力形式（JSON）
{
  "businessType": "業種・業態（例: 婚活マッチングアプリ）",
  "target": "ターゲット層の詳細（例: 25-35歳独身女性、結婚願望あり）",
  "painPoints": ["痛み1", "痛み2"],
  "solution": "提供ソリューション",
  "emotionalTrigger": "感情の変化（例: 焦り → 安心）",
  "framework": {
    "3C": {
      "customer": "顧客のニーズ・ペルソナ",
      "competitor": "競合の訴求ポイント",
      "company": "自社の強み・独自性"
    },
    "AIDMA": {
      "attention": "どう気づかせるか",
      "interest": "どう興味を持たせるか",
      "desire": "どう欲しいと思わせるか",
      "memory": "どう覚えてもらうか",
      "action": "どう行動させるか"
    }
  }
}`;

  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [{ role: "user", content: prompt }],
    response_format: { type: "json_object" }
  });
  
  return JSON.parse(response.choices[0].message.content!);
}

function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = (reader.result as string).split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
```

### 3. OpenAI クライアントの設定確認
`lib/openai.ts` が存在するか確認し、なければ作成：

```typescript
import OpenAI from 'openai';

export const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});
```

### 4. テスト
以下のコマンドで動作確認：

```typescript
// テスト用スクリプト（任意）
const result = await runMarketingAnalysis(
  "url",
  "https://www.pairs.lv/"
);
console.log(result);
```

## 制約
- 既存のファイル（fetch-html.ts, ocr-google.ts, analyzer.ts）は変更しない
- エラーハンドリングを適切に実装
- TypeScript の型安全性を保つ

## 完了条件
- [ ] 型定義が追加されている
- [ ] runMarketingAnalysis 関数が実装されている
- [ ] OpenAI クライアントが設定されている
- [ ] npm run dev でエラーが出ない

実装をお願いします。
```

---

### 8. 準備完了チェックリスト

実装開始前に以下を確認：

- [ ] Git ブランチ作成済み（`feature/gaudi-2.0`）
- [ ] `.env.local` に必要な環境変数がすべて設定済み
- [ ] `npm install js-yaml cheerio` 完了
- [ ] ディレクトリ構造作成済み（`lib/design-system` など）
- [ ] データベースマイグレーション実行済み（007_gaudi_2.0_fields.sql）
- [ ] `IMPLEMENTATION_PLAN.md` 作成済み
- [ ] Cursor に最初のタスクを投げる準備OK

---

## 推奨される作業フロー

```
1. Phase 1（Week 1）
   ├─ Cursor: マーケティング分析実装
   ├─ 手動テスト: https://www.pairs.lv/ で動作確認
   ├─ Git commit: "feat: マーケティング分析機能追加"
   └─ 次のタスクへ

2. Phase 2（Week 2）
   ├─ Cursor: スライド構成生成実装
   ├─ 手動テスト: 6枚のスライドが生成されるか確認
   └─ Git commit

3. Phase 3（Week 3-4）
   ├─ Cursor: 原子ライブラリ構築
   ├─ 手動: YAMLファイル作成（retro-80s.yaml など）
   ├─ Cursor: PromptCompiler実装
   └─ Git commit

4. Phase 4（Week 5-6）
   └─ UI実装
```

---
